## 了解SQL 

### 数据库基础

数据库是一个以某种有组织的方式存储的数据集合，可以将其想象为一个文件柜。此文件柜是一个存放数据的物理位置，不管数据是 什么以及如何组织的。

所以，数据库（database）是保存有阻止的数据的容器（通常是一个文件或一组文件）。在很大程度上说，你并直接访问数据，需要使用DBMS来访问。

#### 表

在数据库领域中，表是一种结构化的文件，可用来存储某种特定类型的数据。另外，数据库中的每个表都有一个唯一的名字，用来标识自己。

#### 模式

表具有一些特性，这些特性定义了数据在表中如何存储，如可以存储什么样的数据，数据如何分解，各部分信息如何命名，等等。描述表的这组信息就是所谓的模式，模式可以用来描述数据库中特定的表以及整个数据库（和其中表的关系）。

#### 列和数据类

表由列组成。列中存储着表中某部分的信息。另外，每个列都有相应的数据类型。数据类型定义列可以存储的数据种类。

数据类型限制可存储在列中的数据种类（例如，防止在数值字段中 录入字符值）。数据类型还帮助正确地排序数据，并在优化磁盘使用方面起重要的作用。因此，在创建表的时候必须对数据类型给予特别的关注。

#### 行

行是表中的一个记录。

#### 主键

主键是一列或一组列，其值能够唯一区分表中的每个行。如果没有主键，更新或删除表中特定行很困难。

> 虽然并不总是都需要主键，但大多数数据库设计人员都应保证创建的每个表具有一个主键，以便于以后的数据操纵和管理。

表中的任何列都可以作为主键，只要它满足以下条件：

* 任意两行都不具有相同的主键值
* 每个行都必须具有一个主键值（主键列不允许NULL值）

主键通常定义在表的一列上，但这并不是必需的，也可以一起使用 多个列作为主键。在使用多列作为主键时，上述条件必须应用到构成主 键的所有列，所有列值的组合必须是唯一的（但单个列的值可以不唯一）。

除了上面MySQL强制实施的规则之外，应该坚持下面普遍任何的好习惯：

* 不更新主键列中的值
* 不重用主键列的值
* 不再主键列中使用可能会更改的值

注意：还有一个非常重要的键，称为外键。 

### 什么是SQL

SQL是结构化查询语言（Structured Query Language）的缩写。SQL是一种专门用来与数据库通信的语言。

SQL有如下的优点：

* SQL不是某个特定数据库供应商专有的语言。几乎所有重要的 DBMS都支持SQL
* SQL简单易学。它的语句全都是由描述性很强的英语单词组成， 而且这些单词的数目不多
* SQL尽管看上去很简单，但它实际上是一种强有力的语言，灵活使用其语言元素，可以进行非常复杂和高级的数据库操作

> SQL不是一种专利语言，而且存在一个标准委员会，他们试图定义可供所有DBMS使用的SQL语法，但是不同的DBMS实现的SQL都不完全相同。所以，不要认为这些SQL语法是完全可移植的。

## MySQL简介

### 什么是MySQL

数据的所有存储、 检索、管理和处理实际上是由数据库软件——DBMS（数据库管理系统） 完成的。MySQL是一种DBMS，它有如下优点：

* 低成本
* 高性能——MySQL执行很快
* 简单

### 客户机—服务器软件

DBMS可分为两类：一类为基于共享文件系统的DBMS，另一类为基于客户机—服务器的DBMS。前者用于桌面用途，通常不用于高端或更关键的应用。例如：Microsoft Access和FileMaker。

MySQL、Oracle以及Microsoft SQL Server等数据库是基于客户机—服务器的数据库。客户机—服务器应用分为两个不同的部分。服务器部分是 负责所有数据访问和处理的一个软件。这个软件运行在称为数据库服务器的计算机上。

与数据文件打交道的只有服务器软件。关于数据、数据添加、删除和数据更新的所有请求都由服务器软件完成。这些请求或更改来自运行客户机软件的计算机。客户机是与用户打交道的软件。例如，如果你请求一个按字母顺序列出的产品表，则客户机软件通过网络提交该请求给服务器软件。服务器软件处理这个请求，根据需要过滤、丢弃和排序数 据；然后把结果送回到你的客户机软件。

> 客户机和服务器软件可能安装在两台计算机或一台计算机上。不管它们在不在相同的计算机上，为进行所有数据库交互，客户机软件都要与服务器软件进行通信。

所有这些活动对用户都是透明的。数据存储在别的地方，或者数据库服务器为你完成这个处理这一事实是隐藏的。你不需要直接访问数据文件。事实上，多数网络的建立使用户不具有对数据的访问权，甚至不具有对存储数据的驱动器的访问权。

* 服务器软件为MySQL DBMS
* 客户机可以是MySQL提供的工具、脚本语言、Web应用开发语言等

### MySQL工具

MySQL是一个客户机—服务器DBMS，因此，为了使用 MySQL，需要有一个客户机，即你需要用来与MySQL打交道（给MySQL 提供要执行的命令）的一个应用。

每个MySQL安装都有一个名为mysql的简单命令行实用程序。这个实用程序没有下拉菜单、流行的用户界面、鼠标支持或任何类似的东西。

当然，具体的版本和连接信息可能不同，但都可以使用这个实用程序。请注意：

* 命令输入在mysql>之后
* 命令用;或\g结束，换句话说，仅按Enter不执行命令
* 输入help或\h获得帮助
* 输入quit或exit退出命令行实用程序

## 使用MySQL

### 连接

MySQL与所有客户机—服务器DBMS一样，要求在能执行命令之前登录到DBMS。登录名可以与网络登录名不相同（假定你使用网络）。MySQL 在内部保存自己的用户列表，并且把每个用户与各种权限关联起来。

在最初安装MySQL时，很可能会要求你输入一个管理登录（通常为root）和一个口令。如果你使用的是自己的本地服务器，并且是简单地试验一下MySQL，使用上述登录就可以了。但现实中，管理登录受到密切保护（因为对它的访问授予了创建表、删除整个数据库、更改登录和口令等完全的权限）。

为了连接到MySQL，需要以下信息：

* 主机名（计算机名）——如果连接到本地MySQL服务器，为localhost
* 端口（如果使用默认端口3306之外的端口）
* 一个合法的用户名
* 用户口令（如果需要）

```bash
mysql -uroot -pxxx
```

> MySQL的键值之间不需要空格，虽然最新版本的MySQL支持加上空格，但是仍然有一些参数不支持，所以建议统一不加空格。

### 选择数据库

在你最初连接到MySQL时，没有任何数据库打开供你使用。所以你需要先选择一个数据库。

通过`show databases;`查看所有可用的数据库，接着通过`use koa_demo;`选中指定的数据库。

注意：必须先使用USE打开数据库，然后才能读取其中的数据。

当然，你还可以通过`show tables;`来查看选中数据库中所有表的列表，或者通过`show columns from koa_demo;`来查看表列。当使用`show columns`时需要指定表名，你也可以使用`describe koa_demo`作为它的一种快捷方式。

> 什么是自动增量？某些表列需要唯一值，MySQL可以自动地位每行分配下一个可用编号，不用手动分配唯一值，这就叫做自动增量。如果需要它，则必须在用create语句创建表时把它作为表定义的组成部分。

所支持的其他SHOW语句还有：

* SHOW STATUS，用于显示广泛的服务器状态信息
* SHOW CREATE DATABASE和SHOW CREATE TABLE，分别用来显示创建特定数据库或表的MySQL语句
* SHOW GRANTS，用来显示授予用户（所有用户或特定用户）的安全权限
* SHOW ERRORS和SHOW WARNINGS，用来显示服务器错误或警告消息

通过`help show;`来查看所有可用的show语句。

## 检索数据

### 检索单个列

通过`select name from db_name;`来检索单个列。当然，你还可以加上`select distinct name from db_name`来查询唯一的行。也就是说，distinct关键字会删除重复的列。

注意：返回数据的顺序可能是数据被添加到表中的顺序，也可能不是。但是只要返回相同数目的行就是正确的，关于排序后面会详细了解。

> 多条SQL语句必须以分号分隔，单条没有限制。建议和mysql命令一样都加上。另外，SQL语句是不区分大小写的，当然普遍认为关键字使用大写，表名和列使用小写，这样可读写更强。

### 检索多个列

通过`select name, age from db_indo;`来检索多个列，列名之间用逗号隔开。

要想从一个表中检索多个列，使用相同的SELECT语句。唯一的不同 是必须在SELECT关键字后给出多个列名，列名之间必须以逗号分隔。

### 检索所有列

通过`slelect * from db_info`来检索所有列。

列的顺序一般是列在表定义中出现的顺序，但有时候并不是这样的，表的模式的变化（如添加或删除列）可能会导致顺序的变化。

注意：虽然使用`*`省时，检索不需要的列通常会降低检索和应用程序的性能，所以不建议每次都这样使用。

### 限制结果

通过`select name from db_info limit 2`来限制查询的结果，这样返回的结果不多于2行。为了得到下一个2行，可指定要检索的开始行和行数，例如`select name from db_info limit 2 2;`。

所以，带一个值的LIMIT总是从第一行开始，给出的数为返回的行数。带两个值的LIMIT可以指定从行号为第一个值的位置开始。

> 1. 行0。检索出来的第一行为行0而不是行1，因此limit1, 1将检索出第二行而不是第一行
> 2. 行数不够。当行数不够时，能返回多少是多少
> 3. 新语法。MySQL5支持LIMIT的替代语法，limit 4 offset 3 === limit 3, 4

### 使用完全限定的表名

通过`select db_info.name from db_info;`来限制列名。当然表名也是可以限制的，例如`select db_info.name koa_demo.db`

## 排序检索数据

### 排序数据

前面了解到，如果不按照特定顺序检索数据，那么检索出的数据一般以它在底层表中出现的顺序显示。这可以是数据最初添加到表中的顺序。但是，如果数据后来进行过更新或删除，则顺序将会受到MySQL重用回收空间的影响。

关系数据库设计理论认为，如果不明确规定排序顺序，则不应该假定检索出的数据的顺序有意义。

SQL语句是由子句（clause）构成，有些子句是必须的，有些是可选的。而为了明确地排序用SELECT语句检索出的数据，可使用ORDER BY子句。例如`select name from db_info order by name`，这样就会以字母顺序排序数据。

当然你也可以检索多个列，然后按照其中多个列进行排序。例如`select name, age, sex from db_info order by name, age;`，首先按照name排序，然后按照年龄。

### 指定排序方向

默认的数据排序是以升序进行排序，当然你也可以使用DESC关键字进行降序排序。例如`seelct name,age from db_info order by name desc`。

如果有多个列，只需要使用desc修饰指定的列名即可。例如`select age, name from db_info order by age desc, name;`，这样会先按照age降序排，得到的结果再按照name升序排。

> 升序的关键字是ASC（ASCENDING），因为默认是升序的，所以可以不指定ASC关键字。

注意：大多数DBMS软件在排序检索时，大小写默认是相同的，也就是说a和A是一样的。当然，数据库管理员可以改变这一默认行为。

另外，你也可以在降序的同时再限制检索数目，但是limit子句要在order by子句之后。

## 过滤数据

### 使用where子句 

数据库表一般包含大量的数据，很少需要检索表中所有行。通常只会根据特定操作或报告的需要提取表数据的子集。只检索所需数据需要指定过滤条件。

在SELECT语句中，数据根据WHERE子句中指定的搜索条件进行过滤。例如`select name, age from db_info where age = 12;`。

> 在同时使用ORDER BY和WHERE子句时，应该让ORDER BY在WHERE之后，否则将会报错。

常见的WHERE子句操作符如下：

| 操作符  | 说明               |
| ------- | ------------------ |
| =       | 等于               |
| <>      | 不等于             |
| !=      | 不等于             |
| <       | 小于               |
| <=      | 小于等于           |
| >       | 大于               |
| `>=`    | 大于等于           |
| BETWEEN | 在指定的两个值之间 |

#### 检查单个值

通过`select name from db_info where name = 'ugu'`可以查询name=ugu的结果行，MySQL在执行匹配时默认不区分大小写，所以Ugu=ugu。

#### 检查范围值

通过`select age from db_info where age between 10 and 20`可以查询`10<=name<=20`之间的结果行。

#### 空值检查

在创建表时，表设计人员可以指定其中的列是否可以不包含值。在一个列不包含值时，称其为包含空值NULL。

> 注意：NULL与0、空字符串以及仅包含空格不同。

通过`select name from db_info where name IS NULL;`来检索具有NULL值的列。

注意：不匹配的结果列中可能包含具有NULL值的列，因为NULL值不和任何值匹配。

## 数据过滤

### AND操作符

通过`select name, age from db_info where name = 'ugu' AND where age > 20;`，查询name=ugu以及name>20的结果列。

### OR操作符

通过`select name, age from db_info where name = 'ugu' OR where age > 20;`，查询name=ugu或者name>20的结果列。

当两者联合使用时，AND操作符优先级要比OR操作符高，你可以通过`()`来改变优先级。例如`select name, age, sex from db_info where (name = 'ugu' OR where age > 20) and sex = 'man'  `。

### IN操作符

圆括号在WHERE子句中还有另外一种用法。IN操作符用来指定条件范围，范围中的每个条件都可以进行匹配。例如`select name from db_info where age in (12, 20);`，查询age=12或者age=20的结果列。

IN操作符相较于OR操作符优点如下：

* IN操作符比OR操作符执行更快
* IN操作符更加直观
* IN操作符可以包含其他SELECT语句，使得能够更动态地建立WHERE子句

### NOT操作符

NOT操作符用来否定后跟条件。例如`select name from db_info where age NOT IN (12, 20);`，查询所有age!=12或者age!=20的结果列。

## 用通配符进行过滤

前面讲解的都是对准确值进行检索，在很多时候需要进行通配符进行搜索。

### %通配符

通过`select name, age from db_info where name LIKE 'ug%';`，查询name以ug开头的结果列。通过`select name, age from db_info where name LIKE '%u%';`，查询name包含u的结果列。通过`select name, age from db_info where name LIKE 'u%u';`，查询name以u为开头结尾的结果列。

注意：默认情况下，检索是不区分大小写的。

另外，尾空格可能会干扰通配合匹配。例如`'ug '!='ug' `，解决这个问题的方法是在搜索摸下最后附加一个%，更好的办法是使用函数。

%能匹配0个，1个以及任意多个字符，虽然看起来能匹配任何东西，但是NULL是不能匹配的。

### _匹配符

和%能匹配多个字符不同的是，`_`只能匹配单个字符。例如`select name, age from db_info where name LIKE '_g';`，查询name=`*`g的结果列。

注意：`_`总是匹配一个字符，不能多不能少。

### 技巧

通配符虽然很有用，但是性能往往不高，所以不要过度使用通配符，能用其它查询语句代替就使用其它查询。
